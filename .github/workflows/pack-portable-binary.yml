name: Pack & Release Portable Binary

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      should-proceed: ${{ steps.version-check.outputs.should-proceed }}
      github-tag: ${{ steps.get-github-tag.outputs.tag }}
      docker-tag: ${{ steps.get-docker-tag.outputs.tag }}
    steps:
      - name: Get latest GitHub release tag
        id: get-github-tag
        run: |
          GITHUB_TAG=$(curl -s 'https://api.github.com/repos/ssfun/lobe-chat-database/releases/latest' | jq -r '.tag_name')
          echo "tag=$GITHUB_TAG" >> $GITHUB_OUTPUT
          echo "GitHub latest tag: $GITHUB_TAG"

      - name: Get latest Docker image tag
        id: get-docker-tag
        run: |
          DOCKER_TAG=$(curl -s 'https://registry.hub.docker.com/v2/repositories/sfun/lobe-chat/tags?page_size=1&ordering=last_updated' | jq -r '.results[0].name')
          echo "tag=$DOCKER_TAG" >> $GITHUB_OUTPUT
          echo "Docker latest tag: $DOCKER_TAG"

      - name: Compare versions
        id: version-check
        run: |
          GITHUB_TAG="${{ steps.get-github-tag.outputs.tag }}"
          DOCKER_TAG="${{ steps.get-docker-tag.outputs.tag }}"
          
          # 移除前缀v（如果存在）
          GITHUB_VERSION="${GITHUB_TAG#v}"
          DOCKER_VERSION="${DOCKER_TAG#v}"
          
          # 使用版本号比较
          if [ "$(printf '%s\n' "$GITHUB_VERSION" "$DOCKER_VERSION" | sort -V | head -n1)" = "$GITHUB_VERSION" ] && [ "$GITHUB_VERSION" != "$DOCKER_VERSION" ]; then
            echo "GitHub version ($GITHUB_VERSION) is less than Docker version ($DOCKER_VERSION)"
            echo "should-proceed=true" >> $GITHUB_OUTPUT
          else
            echo "GitHub version ($GITHUB_VERSION) is not less than Docker version ($DOCKER_VERSION), skipping build"
            echo "should-proceed=false" >> $GITHUB_OUTPUT
          fi

  pack-and-release:
    runs-on: ubuntu-latest
    needs: check-versions
    if: needs.check-versions.outputs.should-proceed == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up dependencies for dockerc
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse overlayroot squashfs-tools skopeo jq curl

      - name: Download dockerc
        run: |
          wget -O dockerc https://github.com/NilsIrl/dockerc/releases/download/v0.3.2/dockerc_x86-64
          chmod +x ./dockerc

      - name: Pack sfun/lobe-chat:${{ needs.check-versions.outputs.docker-tag }} for linux/amd64
        run: |
          ./dockerc --image docker://sfun/lobe-chat:${{ needs.check-versions.outputs.docker-tag }} --arch amd64 --output lobe-chat-${{ needs.check-versions.outputs.docker-tag }}-linux-amd64.bin

      - name: Pack sfun/lobe-chat:${{ needs.check-versions.outputs.docker-tag }} for linux/arm64
        run: |
          ./dockerc --image docker://sfun/lobe-chat:${{ needs.check-versions.outputs.docker-tag }} --arch arm64 --output lobe-chat-${{ needs.check-versions.outputs.docker-tag }}-linux-arm64.bin

      - name: Upload all bins to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-versions.outputs.docker-tag }}
          files: |
            lobe-chat-${{ needs.check-versions.outputs.docker-tag }}-linux-amd64.bin
            lobe-chat-${{ needs.check-versions.outputs.docker-tag }}-linux-arm64.bin
          token: ${{ secrets.GITHUB_TOKEN }}

  skip-notification:
    runs-on: ubuntu-latest
    needs: check-versions
    if: needs.check-versions.outputs.should-proceed == 'false'
    steps:
      - name: Log skip reason
