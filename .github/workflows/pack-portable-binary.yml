name: Pack & Release & Deploy Portable Binary

on:
  workflow_dispatch:
  schedule:
    - cron: '15 1 * * *' 

permissions:
  contents: write

jobs:
  pack-and-release:
    runs-on: ubuntu-latest
    outputs:
      should_pack: ${{ steps.version_check.outputs.should_pack }}
      github_tag: ${{ steps.get_github_tag.outputs.tag }}
      docker_tag: ${{ steps.get_docker_tag.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest lobehub/lobe-chat-database docker tag
        id: get_docker_tag
        run: |
          # è·å–æ‰€æœ‰æ ‡ç­¾ï¼Œè¿‡æ»¤æ‰ latest å’Œéç‰ˆæœ¬æ ‡ç­¾
          echo "Fetching Docker Hub tags..."
          
          # è·å–å‰100ä¸ªæ ‡ç­¾ï¼ˆé€šå¸¸è¶³å¤Ÿæ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬ï¼‰
          TAGS_JSON=$(curl -s 'https://registry.hub.docker.com/v2/repositories/lobehub/lobe-chat-database/tags?page_size=100')
          
          # æå–æ‰€æœ‰æ ‡ç­¾åï¼Œè¿‡æ»¤å‡ºç‰ˆæœ¬å·æ ¼å¼çš„æ ‡ç­¾ï¼ˆvå¼€å¤´æˆ–çº¯æ•°å­—ç‰ˆæœ¬ï¼‰
          # æ’é™¤ latest, nightly, dev ç­‰éç‰ˆæœ¬æ ‡ç­¾
          LATEST_VERSION=$(echo "$TAGS_JSON" | jq -r '.results[].name' | \
            grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.\-]+)?$' | \
            grep -v -E '^(latest|nightly|dev|alpha|beta|rc)$' | \
            sort -rV | \
            head -n1)
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰ˆæœ¬æ ‡ç­¾ï¼Œå°è¯•å…¶ä»–æ¨¡å¼
          if [ -z "$LATEST_VERSION" ]; then
            echo "No semantic version found, trying alternative patterns..."
            LATEST_VERSION=$(echo "$TAGS_JSON" | jq -r '.results[].name' | \
              grep -E '^[0-9]+\.[0-9]+' | \
              grep -v -E '^(latest|nightly|dev)$' | \
              sort -rV | \
              head -n1)
          fi
          
          # ç¡®ä¿æ‰¾åˆ°äº†æœ‰æ•ˆçš„ç‰ˆæœ¬
          if [ -z "$LATEST_VERSION" ]; then
            echo "ERROR: No valid version tag found in Docker Hub"
            exit 1
          fi
          
          echo "LATEST_TAG=$LATEST_VERSION" >> $GITHUB_ENV
          echo "tag=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Docker latest version tag: $LATEST_VERSION"

      - name: Get latest ssfun/lobe-chat-database GitHub release tag
        id: get_github_tag
        run: |
          # å°è¯•è·å–æœ€æ–°çš„ release
          RESPONSE=$(curl -s -w "\n%{http_code}" 'https://api.github.com/repos/ssfun/lobe-chat-database/releases/latest')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" = "404" ]; then
            echo "No releases found in GitHub repository"
            GITHUB_TAG="v0.0.0"
            echo "Using default version: $GITHUB_TAG"
          elif [ "$HTTP_CODE" = "200" ]; then
            GITHUB_TAG=$(echo "$BODY" | jq -r '.tag_name')
            if [ "$GITHUB_TAG" = "null" ] || [ -z "$GITHUB_TAG" ]; then
              echo "No valid tag found in latest release"
              GITHUB_TAG="v0.0.0"
              echo "Using default version: $GITHUB_TAG"
            else
              echo "Found GitHub release tag: $GITHUB_TAG"
            fi
          else
            echo "Failed to fetch GitHub releases. HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            # å°è¯•è·å–æ‰€æœ‰æ ‡ç­¾ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
            echo "Trying to fetch tags instead..."
            GITHUB_TAG=$(curl -s 'https://api.github.com/repos/ssfun/lobe-chat-database/tags' | \
              jq -r '.[].name' | \
              grep -E '^v?[0-9]+\.[0-9]+' | \
              sort -rV | \
              head -n1)
            
            if [ -z "$GITHUB_TAG" ]; then
              GITHUB_TAG="v0.0.0"
              echo "No tags found, using default: $GITHUB_TAG"
            else
              echo "Found GitHub tag: $GITHUB_TAG"
            fi
          fi
          
          echo "GITHUB_TAG=$GITHUB_TAG" >> $GITHUB_ENV
          echo "tag=$GITHUB_TAG" >> $GITHUB_OUTPUT
          echo "GitHub latest tag: $GITHUB_TAG"

      - name: Compare versions and decide if packing is needed
        id: version_check
        run: |
          # æ ‡å‡†åŒ–ç‰ˆæœ¬å·æ ¼å¼ï¼ˆç§»é™¤ v å‰ç¼€ï¼‰
          DOCKER_VERSION="${LATEST_TAG#v}"
          GITHUB_VERSION="${GITHUB_TAG#v}"
          
          echo "Comparing versions:"
          echo "Docker version: $DOCKER_VERSION"
          echo "GitHub version: $GITHUB_VERSION"
          
          # ç‰ˆæœ¬æ¯”è¾ƒå‡½æ•°
          version_gt() {
            # ä½¿ç”¨ sort -V è¿›è¡Œç‰ˆæœ¬æ¯”è¾ƒ
            # å¦‚æœç¬¬ä¸€ä¸ªç‰ˆæœ¬å¤§äºç¬¬äºŒä¸ªç‰ˆæœ¬ï¼Œè¿”å› 0ï¼ˆtrueï¼‰
            [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" != "$1" ]
          }
          
          # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦ç›¸åŒ
          if [ "$DOCKER_VERSION" = "$GITHUB_VERSION" ]; then
            echo "Versions are identical, no need to pack"
            echo "should_pack=false" >> $GITHUB_OUTPUT
          elif version_gt "$DOCKER_VERSION" "$GITHUB_VERSION"; then
            echo "Docker version ($DOCKER_VERSION) is newer than GitHub version ($GITHUB_VERSION)"
            echo "should_pack=true" >> $GITHUB_OUTPUT
          else
            echo "Docker version ($DOCKER_VERSION) is not newer than GitHub version ($GITHUB_VERSION)"
            echo "should_pack=false" >> $GITHUB_OUTPUT
          fi
          
          # è¾“å‡ºå†³ç­–æ‘˜è¦
          echo "---"
          echo "Decision summary:"
          echo "  Docker Hub version: v$DOCKER_VERSION"
          echo "  GitHub Release version: v$GITHUB_VERSION"
          echo "  Should pack: $([ "$DOCKER_VERSION" != "$GITHUB_VERSION" ] && version_gt "$DOCKER_VERSION" "$GITHUB_VERSION" && echo "YES" || echo "NO")"

  pack-binaries:
    needs: pack-and-release
    if: needs.pack-and-release.outputs.should_pack == 'true'
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.set_release_output.outputs.release_created }}
      version_tag: ${{ needs.pack-and-release.outputs.docker_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up dependencies for dockerc
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse overlayroot squashfs-tools skopeo jq curl

      - name: Download dockerc
        run: |
          wget -O dockerc https://github.com/NilsIrl/dockerc/releases/download/v0.3.2/dockerc_x86-64
          chmod +x ./dockerc

      - name: Pack lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }} for linux/amd64
        run: |
          echo "Packing AMD64 binary for version: ${{ needs.pack-and-release.outputs.docker_tag }}"
          ./dockerc --image docker://lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }} \
            --arch amd64 \
            --output lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin

      - name: Pack lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }} for linux/arm64
        run: |
          echo "Packing ARM64 binary for version: ${{ needs.pack-and-release.outputs.docker_tag }}"
          ./dockerc --image docker://lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }} \
            --arch arm64 \
            --output lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-arm64.bin

      - name: Generate SHA256 checksums
        run: |
          sha256sum lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin > checksums.txt
          sha256sum lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-arm64.bin >> checksums.txt
          echo "Generated checksums:"
          cat checksums.txt

      - name: Upload all bins to Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.pack-and-release.outputs.docker_tag }}
          files: |
            lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin
            lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-arm64.bin
            checksums.txt
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Release ${{ needs.pack-and-release.outputs.docker_tag }}"
          body: |
            ## ğŸš€ Automated Release for lobe-chat ${{ needs.pack-and-release.outputs.docker_tag }}
            
            ### ğŸ“¦ Version Information
            - **Docker image version:** `${{ needs.pack-and-release.outputs.docker_tag }}`
            - **Previous GitHub release:** `${{ needs.pack-and-release.outputs.github_tag }}`
            - **Release date:** `${{ github.event.head_commit.timestamp }}`
            
            ### ğŸ“¥ Downloads
            This release contains portable binary executables packed from the official Docker image.
            
            | Platform | Architecture | File |
            |----------|-------------|------|
            | Linux | x86_64/amd64 | `lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin` |
            | Linux | arm64/aarch64 | `lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-arm64.bin` |
            
            ### ğŸ”’ Verification
            SHA256 checksums are available in `checksums.txt`
            
            ### ğŸ“ Usage
            ```bash
            # Download the binary
            wget https://github.com/ssfun/lobe-chat-database/releases/download/${{ needs.pack-and-release.outputs.docker_tag }}/lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin
            
            # Make it executable
            chmod +x lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin
            
            # Run
            ./lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin
            ```
            
            ### ğŸ³ Docker Image
            Original Docker image: `lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }}`
            
            ---
            *This release was automatically generated from the Docker Hub image.*
      
      # å…³é”®ä¿®å¤ï¼šæ­£ç¡®è®¾ç½®è¾“å‡ºå˜é‡
      - name: Set release output
        id: set_release_output
        if: always()
        run: |
          # æ£€æŸ¥ä¸Šä¸€æ­¥æ˜¯å¦æˆåŠŸ
          if [ "${{ steps.create_release.outcome }}" == "success" ]; then
            echo "Release created successfully"
            echo "release_created=true" >> $GITHUB_OUTPUT
          else
            echo "Release creation failed or skipped"
            echo "release_created=false" >> $GITHUB_OUTPUT
          fi
          
          # è°ƒè¯•è¾“å‡º
          echo "::notice ::Release creation status: ${{ steps.create_release.outcome }}"
          echo "::notice ::Release will trigger deployment: $([ "${{ steps.create_release.outcome }}" == "success" ] && echo "YES" || echo "NO")"

  deploy-to-server:
    needs: [pack-binaries]
    # ä¿®æ”¹æ¡ä»¶åˆ¤æ–­ï¼Œç¡®ä¿æ­£ç¡®è§¦å‘
    if: |
      always() && 
      needs.pack-binaries.result == 'success' && 
      needs.pack-binaries.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # å…è®¸éƒ¨åˆ†æœåŠ¡å™¨å¤±è´¥è€Œä¸å½±å“å…¶ä»–æœåŠ¡å™¨
      matrix:
        server: [server1]  # å¯ä»¥æ‰©å±•ä¸ºå¤šä¸ªæœåŠ¡å™¨ [server1, server2, server3]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # æ·»åŠ è°ƒè¯•ä¿¡æ¯
      - name: Debug deployment trigger
        run: |
          echo "::notice ::Starting deployment to ${{ matrix.server }}"
          echo "Release created: ${{ needs.pack-binaries.outputs.release_created }}"
          echo "Version tag: ${{ needs.pack-binaries.outputs.version_tag }}"
          echo "Pack binaries result: ${{ needs.pack-binaries.result }}"

      - name: Check server configuration
        env:
          SERVER_HOST: ${{ secrets[format('{0}_HOST', matrix.server)] }}
          SERVER_USER: ${{ secrets[format('{0}_USER', matrix.server)] }}
          LOBE_CHAT_ENV: ${{ secrets[format('{0}_LOBE_CHAT_ENV', matrix.server)] }}
        run: |
          # æ£€æŸ¥å¿…éœ€çš„é…ç½®æ˜¯å¦å­˜åœ¨
          if [ -z "${SERVER_HOST}" ] || [ -z "${SERVER_USER}" ]; then
            echo "::error ::Missing required secrets for ${{ matrix.server }}"
            echo "Please configure the following secrets in your repository:"
            echo "  - ${{ matrix.server }}_HOST"
            echo "  - ${{ matrix.server }}_USER"
            echo "  - ${{ matrix.server }}_PASSWORD"
            exit 1
          fi
          echo "Server configuration verified for ${{ matrix.server }}"
          
          # è°ƒè¯•ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨ï¼ˆéšè—å€¼ï¼‰
          if [ ! -z "${LOBE_CHAT_ENV}" ]; then
            echo "LOBE_CHAT_ENV is configured (length: ${#LOBE_CHAT_ENV} chars)"
            # æ˜¾ç¤ºå‰10ä¸ªå­—ç¬¦ç”¨äºè°ƒè¯•
            echo "LOBE_CHAT_ENV starts with: ${LOBE_CHAT_ENV:0:10}..."
          else
            echo "WARNING: LOBE_CHAT_ENV is not configured"
          fi

      - name: Deploy to ${{ matrix.server }}
        env:
          SERVER_HOST: ${{ secrets[format('{0}_HOST', matrix.server)] }}
          SERVER_USER: ${{ secrets[format('{0}_USER', matrix.server)] }}
          SERVER_PASSWORD: ${{ secrets[format('{0}_PASSWORD', matrix.server)] }}
          SERVER_PORT: ${{ secrets[format('{0}_PORT', matrix.server)] || '22' }}
          LOBE_CHAT_ENV: ${{ secrets[format('{0}_LOBE_CHAT_ENV', matrix.server)] || '' }}
          VERSION_TAG: ${{ needs.pack-binaries.outputs.version_tag }}
        run: |
          # å®‰è£… sshpass ç”¨äºå¯†ç ç™»å½•
          sudo apt-get update && sudo apt-get install -y sshpass
          
          echo "Deploying version ${VERSION_TAG} to ${SERVER_HOST}"
          
          # è°ƒè¯•ï¼šæ˜¾ç¤ºç¯å¢ƒå˜é‡ä¼ é€’çŠ¶æ€
          if [ ! -z "${LOBE_CHAT_ENV}" ]; then
            echo "Environment variables will be passed to deployment script"
            echo "Total length: ${#LOBE_CHAT_ENV} characters"
          else
            echo "No environment variables to pass"
          fi
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          VERSION_TAG="${1}"
          shift  # ç§»é™¤ç¬¬ä¸€ä¸ªå‚æ•°
          LOBE_CHAT_ENV="$@"  # å‰©ä½™çš„æ‰€æœ‰å‚æ•°ä½œä¸ºç¯å¢ƒå˜é‡
          
          echo "========================================="
          echo "Starting deployment of lobe-chat"
          echo "Version: ${VERSION_TAG}"
          echo "Time: $(date)"
          echo "========================================="
          
          # è°ƒè¯•ï¼šæ˜¾ç¤ºæ”¶åˆ°çš„ç¯å¢ƒå˜é‡
          if [ ! -z "${LOBE_CHAT_ENV}" ]; then
              echo "Received environment variables (length: ${#LOBE_CHAT_ENV})"
              # æ˜¾ç¤ºå‰50ä¸ªå­—ç¬¦ç”¨äºè°ƒè¯•
              echo "Environment starts with: ${LOBE_CHAT_ENV:0:50}..."
          else
              echo "No environment variables received"
          fi
          
          # æ£€æµ‹æ˜¯å¦ä¸º root ç”¨æˆ·æˆ–å…·æœ‰ sudo æƒé™
          SUDO_CMD=""
          if [ "$EUID" -ne 0 ]; then
              # ä¸æ˜¯ root ç”¨æˆ·ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ sudo æƒé™
              if command -v sudo >/dev/null 2>&1 && sudo -n true 2>/dev/null; then
                  SUDO_CMD="sudo"
                  echo "Running with sudo privileges"
              else
                  echo "Running as non-root user without sudo"
              fi
          else
              echo "Running as root user"
          fi
          
          # æ£€æµ‹ç³»ç»Ÿæ¶æ„
          ARCH=$(uname -m)
          case ${ARCH} in
              x86_64)
                  BINARY_ARCH="amd64"
                  ;;
              aarch64|arm64)
                  BINARY_ARCH="arm64"
                  ;;
              *)
                  echo "ERROR: Unsupported architecture: ${ARCH}"
                  exit 1
                  ;;
          esac
          
          echo "System architecture: ${ARCH} (binary: ${BINARY_ARCH})"
          
          # ä¸‹è½½å¯¹åº”æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
          DOWNLOAD_URL="https://github.com/ssfun/lobe-chat-database/releases/download/${VERSION_TAG}/lobe-chat-${VERSION_TAG}-linux-${BINARY_ARCH}.bin"
          echo "Download URL: ${DOWNLOAD_URL}"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          TEMP_DIR=$(mktemp -d)
          cd ${TEMP_DIR}
          echo "Working in temporary directory: ${TEMP_DIR}"
          
          # ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
          echo "Downloading binary file..."
          for i in {1..3}; do
              if wget --progress=dot:giga -O lobe-chat.bin "${DOWNLOAD_URL}"; then
                  echo "Download completed successfully"
                  break
              else
                  echo "Download attempt $i failed"
                  if [ $i -eq 3 ]; then
                      echo "ERROR: Failed to download after 3 attempts"
                      exit 1
                  fi
                  sleep 5
              fi
          done
          
          # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
          if [ ! -f lobe-chat.bin ]; then
              echo "ERROR: Downloaded file not found"
              exit 1
          fi
          
          FILE_SIZE=$(stat -c%s lobe-chat.bin)
          echo "Downloaded file size: ${FILE_SIZE} bytes"
          
          if [ ${FILE_SIZE} -lt 1000000 ]; then
              echo "ERROR: Downloaded file seems too small (${FILE_SIZE} bytes)"
              exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰è¿è¡Œä¸­çš„ lobe-chat è¿›ç¨‹
          echo "Checking for running lobe-chat process..."
          OLD_PIDS=$(pgrep -f "/opt/lobe-chat/lobe-chat.bin" || true)
          
          if [ ! -z "${OLD_PIDS}" ]; then
              echo "Found running process(es):"
              echo "${OLD_PIDS}"
              echo "Stopping old process(es)..."
              
              # å°è¯•ä¼˜é›…å…³é—­æ‰€æœ‰è¿›ç¨‹
              for PID in ${OLD_PIDS}; do
                  echo "Stopping PID: ${PID}"
                  kill ${PID} 2>/dev/null || true
              done
              
              # ç­‰å¾…è¿›ç¨‹ç»“æŸ
              sleep 3
              
              # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è¿›ç¨‹å­˜æ´»
              REMAINING_PIDS=$(pgrep -f "/opt/lobe-chat/lobe-chat.bin" || true)
              if [ ! -z "${REMAINING_PIDS}" ]; then
                  echo "Force killing remaining processes..."
                  for PID in ${REMAINING_PIDS}; do
                      kill -9 ${PID} 2>/dev/null || true
                  done
                  sleep 1
              fi
              
              echo "All old processes stopped"
          else
              echo "No running process found"
          fi
          
          # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if [ ! -d "/opt/lobe-chat" ]; then
              echo "Creating directory /opt/lobe-chat"
              ${SUDO_CMD} mkdir -p /opt/lobe-chat
              
              # å¦‚æœæ˜¯é root ç”¨æˆ·ï¼Œå°è¯•æ›´æ”¹æ‰€æœ‰æƒ
              if [ "$EUID" -ne 0 ] && [ ! -z "${SUDO_CMD}" ]; then
                  ${SUDO_CMD} chown $(whoami):$(whoami) /opt/lobe-chat
              fi
          fi
          
          # åˆ›å»ºæ—¥å¿—ç›®å½•
          ${SUDO_CMD} mkdir -p /opt/lobe-chat/logs
          
          # å¤‡ä»½æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "/opt/lobe-chat/lobe-chat.bin" ]; then
              BACKUP_NAME="lobe-chat.bin.backup.$(date +%Y%m%d_%H%M%S)"
              echo "Backing up old version to ${BACKUP_NAME}"
              ${SUDO_CMD} mv /opt/lobe-chat/lobe-chat.bin /opt/lobe-chat/${BACKUP_NAME}
              
              # ä¿ç•™æœ€è¿‘çš„3ä¸ªå¤‡ä»½
              cd /opt/lobe-chat
              ls -t lobe-chat.bin.backup.* 2>/dev/null | tail -n +4 | xargs -r ${SUDO_CMD} rm -f
              cd ${TEMP_DIR}
          fi
          
          # ç§»åŠ¨æ–°ç‰ˆæœ¬åˆ°ç›®æ ‡ä½ç½®
          echo "Installing new version..."
          ${SUDO_CMD} mv lobe-chat.bin /opt/lobe-chat/lobe-chat.bin
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          echo "Setting permissions..."
          ${SUDO_CMD} chmod +x /opt/lobe-chat/lobe-chat.bin
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          cd /
          rm -rf ${TEMP_DIR}
          
          # å‡†å¤‡æ—¥å¿—æ–‡ä»¶
          LOG_FILE="/opt/lobe-chat/lobe-chat.log"
          ${SUDO_CMD} touch ${LOG_FILE}
          ${SUDO_CMD} chmod 666 ${LOG_FILE}
          
          # æ„å»ºå¯åŠ¨å‘½ä»¤
          echo ""
          echo "Building startup command..."
          
          # åŸºç¡€å‘½ä»¤
          START_CMD="/opt/lobe-chat/lobe-chat.bin"
          
          # å¤„ç†ç¯å¢ƒå˜é‡
          if [ ! -z "${LOBE_CHAT_ENV}" ]; then
              echo "Processing environment variables..."
              
              # ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„ç¯å¢ƒå˜é‡å­—ç¬¦ä¸²
              # å¦‚æœå·²ç»åŒ…å« -eï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™æ·»åŠ  -e
              if echo "${LOBE_CHAT_ENV}" | grep -q "^\-e "; then
                  # å·²ç»æ˜¯æ­£ç¡®æ ¼å¼
                  START_CMD="${START_CMD} ${LOBE_CHAT_ENV}"
                  echo "Using pre-formatted environment arguments"
              else
                  # éœ€è¦æ·»åŠ  -e å‰ç¼€
                  # å°†ç¯å¢ƒå˜é‡æŒ‰ç©ºæ ¼åˆ†å‰²ï¼Œæ¯ä¸ªæ·»åŠ  -e
                  ENV_ARGS=""
                  for env_pair in ${LOBE_CHAT_ENV}; do
                      if [ ! -z "$env_pair" ] && echo "$env_pair" | grep -q '='; then
                          ENV_ARGS="${ENV_ARGS} -e ${env_pair}"
                      fi
                  done
                  START_CMD="${START_CMD} ${ENV_ARGS}"
                  echo "Added -e prefix to environment variables"
              fi
              
              # ç»Ÿè®¡ç¯å¢ƒå˜é‡æ•°é‡
              ENV_COUNT=$(echo "${START_CMD}" | grep -o '\-e ' | wc -l)
              echo "Configured ${ENV_COUNT} environment variable(s)"
              
              # æ˜¾ç¤ºé…ç½®çš„ç¯å¢ƒå˜é‡åï¼ˆéšè—å€¼ï¼‰
              echo "Environment variables:"
              echo "${START_CMD}" | tr ' ' '\n' | grep '^\-e ' | sed 's/-e /  - /' | sed 's/=.*/=***/'
          else
              echo "No environment variables configured"
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆå‘½ä»¤ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
          echo ""
          echo "Final command (values hidden):"
          echo "${START_CMD}" | sed 's/=[-a-zA-Z0-9\/\.:_@]*/=***/g'
          echo ""
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆç”¨äºè°ƒè¯•å’Œé‡å¯ï¼‰
          START_SCRIPT="/opt/lobe-chat/start.sh"
          ${SUDO_CMD} cat > ${START_SCRIPT} << SCRIPT_EOF
          #!/bin/bash
          # Auto-generated startup script
          # Version: ${VERSION_TAG}
          # Generated: $(date)
          
          LOG_FILE="/opt/lobe-chat/lobe-chat.log"
          
          # å¯åŠ¨å‘½ä»¤
          ${START_CMD} > \${LOG_FILE} 2>&1 &
          
          echo "Started lobe-chat with PID: \$!"
          SCRIPT_EOF
          
          ${SUDO_CMD} chmod +x ${START_SCRIPT}
          echo "Startup script saved to ${START_SCRIPT}"
          
          # å¯åŠ¨æœåŠ¡
          echo ""
          echo "Starting lobe-chat service..."
          
          # ä½¿ç”¨ setsid åˆ›å»ºæ–°ä¼šè¯ï¼Œé¿å…ç»ˆç«¯é—®é¢˜
          setsid ${START_CMD} > ${LOG_FILE} 2>&1 &
          
          echo "Service starting, waiting for initialization..."
          sleep 8
          
          # éªŒè¯è¿›ç¨‹æ˜¯å¦æˆåŠŸå¯åŠ¨
          NEW_PIDS=$(pgrep -f "/opt/lobe-chat/lobe-chat.bin" || true)
          if [ ! -z "${NEW_PIDS}" ]; then
              # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦çœŸçš„åœ¨è¿è¡Œï¼ˆå†ç­‰å¾…ä¸€ä¸‹ï¼‰
              sleep 2
              FINAL_PIDS=$(pgrep -f "/opt/lobe-chat/lobe-chat.bin" || true)
              
              if [ ! -z "${FINAL_PIDS}" ]; then
                  echo "========================================="
                  echo "Deployment successful!"
                  echo "Process PID(s): ${FINAL_PIDS}"
                  echo "Version: ${VERSION_TAG}"
                  echo "========================================="
                  
                  # æ˜¾ç¤ºå¯åŠ¨æ—¥å¿—
                  echo ""
                  echo "Startup logs (last 40 lines):"
                  echo "-----------------------------------------"
                  tail -n 40 ${LOG_FILE} 2>/dev/null || true
                  echo "-----------------------------------------"
                  
                  # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                  if tail -n 40 ${LOG_FILE} 2>/dev/null | grep -qi "error\|panic\|failed\|abort"; then
                      echo ""
                      echo "âš ï¸  WARNING: Detected potential errors in logs"
                      echo "Please verify the application is running correctly"
                      
                      # ç‰¹å®šé”™è¯¯æ£€æŸ¥
                      if grep -q "expected environment variable" ${LOG_FILE} 2>/dev/null; then
                          echo "âŒ Missing required environment variables"
                      fi
                      if grep -q "tcgetattr" ${LOG_FILE} 2>/dev/null; then
                          echo "âš ï¸  Terminal-related warning (this can be ignored in background mode)"
                      fi
                      if grep -q "bind: address already in use" ${LOG_FILE} 2>/dev/null; then
                          echo "âŒ Port is already in use"
                      fi
                      
                      # å³ä½¿æœ‰è­¦å‘Šï¼Œå¦‚æœè¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œè®¤ä¸ºæˆåŠŸ
                      if [ ! -z "$(pgrep -f "/opt/lobe-chat/lobe-chat.bin")" ]; then
                          echo ""
                          echo "â„¹ï¸  Process is still running despite warnings"
                          exit 0
                      else
                          exit 1
                      fi
                  else
                      echo ""
                      echo "âœ… No errors detected in startup logs"
                  fi
                  
                  exit 0
              else
                  echo "ERROR: Process started but terminated quickly"
              fi
          fi
          
          # å¯åŠ¨å¤±è´¥
          echo "ERROR: Failed to start lobe-chat"
          echo ""
          echo "Error logs (last 50 lines):"
          echo "-----------------------------------------"
          tail -n 50 ${LOG_FILE} 2>/dev/null || true
          echo "-----------------------------------------"
          
          # åˆ†æé”™è¯¯åŸå› 
          echo ""
          echo "Error analysis:"
          if grep -q "expected environment variable" ${LOG_FILE} 2>/dev/null; then
              echo "âŒ Missing required environment variables"
              echo "   Please check your LOBE_CHAT_ENV configuration"
          fi
          if grep -q "permission denied" ${LOG_FILE} 2>/dev/null; then
              echo "âŒ Permission denied error"
              echo "   Check file permissions and user privileges"
          fi
          if grep -q "no such file or directory" ${LOG_FILE} 2>/dev/null; then
              echo "âŒ File not found error"
              echo "   Check if all required files are present"
          fi
          if grep -q "tcgetattr" ${LOG_FILE} 2>/dev/null; then
              echo "âš ï¸  Terminal issue detected"
              echo "   Try running with different terminal settings"
          fi
          
          exit 1
          EOF
          
          # ä½¿ç”¨ sshpass æ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼Œä¼ é€’ç¯å¢ƒå˜é‡
          echo "::group::Executing deployment on ${SERVER_HOST}"
          
          # æ³¨æ„ï¼šè¿™é‡Œå°†ç¯å¢ƒå˜é‡ä½œä¸ºå‚æ•°ä¼ é€’ç»™è„šæœ¬
          if sshpass -p "${SERVER_PASSWORD}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -p ${SERVER_PORT} ${SERVER_USER}@${SERVER_HOST} \
            "bash -s" < deploy.sh "${VERSION_TAG}" "${LOBE_CHAT_ENV}"; then
            echo "DEPLOYMENT_SUCCESS=true" >> $GITHUB_ENV
            echo "::notice ::âœ… Deployment to ${SERVER_HOST} completed successfully"
          else
            echo "DEPLOYMENT_SUCCESS=false" >> $GITHUB_ENV
            echo "::error ::âŒ Deployment to ${SERVER_HOST} failed"
            exit 1
          fi
          
          echo "::endgroup::"

      - name: Send Telegram notification
        if: env.DEPLOYMENT_SUCCESS == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION_TAG: ${{ needs.pack-binaries.outputs.version_tag }}
          SERVER_NAME: ${{ matrix.server }}
        run: |
          # åªåœ¨é…ç½®äº† Telegram çš„æƒ…å†µä¸‹å‘é€é€šçŸ¥
          if [ ! -z "${TELEGRAM_BOT_TOKEN}" ] && [ ! -z "${TELEGRAM_CHAT_ID}" ]; then
            echo "Sending Telegram notification..."
            
            # æ„å»ºæ¶ˆæ¯å†…å®¹ï¼ˆä½¿ç”¨ JSON æ ¼å¼é¿å…æ ¼å¼é—®é¢˜ï¼‰
            MESSAGE=$(cat <<-END
          {
            "chat_id": "${TELEGRAM_CHAT_ID}",
            "parse_mode": "Markdown",
            "disable_web_page_preview": true,
            "text": "ğŸš€ *Lobe Chat Deployment Success*\n\nğŸ“¦ *Version:* \`${VERSION_TAG}\`\nğŸ–¥ï¸ *Server:* ${SERVER_NAME}\nâ° *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')\nâœ… *Status:* Deployed and running\n\nğŸ”— [View Release](https://github.com/ssfun/lobe-chat-database/releases/tag/${VERSION_TAG})"
          }
          END
          )
            
            # å‘é€ Telegram æ¶ˆæ¯
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "${MESSAGE}")
            
            # æ£€æŸ¥å‘é€ç»“æœ
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram notification sent successfully"
            else
              echo "âš ï¸ Failed to send Telegram notification"
              echo "Response: $RESPONSE"
            fi
          else
            echo "Telegram credentials not configured, skipping notification"
          fi

  # éƒ¨ç½²å¤±è´¥æ—¶çš„é€šçŸ¥
  notify-failure:
    needs: [pack-binaries, deploy-to-server]
    if: |
      always() && 
      (needs.pack-binaries.result == 'failure' || needs.deploy-to-server.result == 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Send failure notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -z "${TELEGRAM_BOT_TOKEN}" ] && [ ! -z "${TELEGRAM_CHAT_ID}" ]; then
            # ç¡®å®šå¤±è´¥çš„é˜¶æ®µ
            FAILED_STAGE=""
            if [ "${{ needs.pack-binaries.result }}" == "failure" ]; then
              FAILED_STAGE="Pack & Release"
            elif [ "${{ needs.deploy-to-server.result }}" == "failure" ]; then
              FAILED_STAGE="Deployment"
            else
              FAILED_STAGE="Unknown"
            fi
            
            # æ„å»ºæ¶ˆæ¯å†…å®¹
            MESSAGE=$(cat <<-END
          {
            "chat_id": "${TELEGRAM_CHAT_ID}",
            "parse_mode": "Markdown",
            "text": "âŒ *Lobe Chat Pipeline Failed*\n\nâš ï¸ *Failed Stage:* ${FAILED_STAGE}\nâ° *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')\nğŸ“ *Workflow:* ${{ github.workflow }}\nğŸ”— [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          }
          END
          )
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "${MESSAGE}"
              
            echo "Failure notification sent"
          fi
