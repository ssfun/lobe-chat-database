name: Pack & Release & Deploy Portable Binary

on:
  workflow_dispatch:
  schedule:
    - cron: '15 1 * * *' 

permissions:
  contents: write

jobs:
  pack-and-release:
    runs-on: ubuntu-latest
    outputs:
      should_pack: ${{ steps.version_check.outputs.should_pack }}
      github_tag: ${{ steps.get_github_tag.outputs.tag }}
      docker_tag: ${{ steps.get_docker_tag.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest lobehub/lobe-chat-database docker tag
        id: get_docker_tag
        run: |
          # 获取所有标签，过滤掉 latest 和非版本标签
          echo "Fetching Docker Hub tags..."
          
          # 获取前100个标签（通常足够找到最新版本）
          TAGS_JSON=$(curl -s 'https://registry.hub.docker.com/v2/repositories/lobehub/lobe-chat-database/tags?page_size=100')
          
          # 提取所有标签名，过滤出版本号格式的标签（v开头或纯数字版本）
          # 排除 latest, nightly, dev 等非版本标签
          LATEST_VERSION=$(echo "$TAGS_JSON" | jq -r '.results[].name' | \
            grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.\-]+)?$' | \
            grep -v -E '^(latest|nightly|dev|alpha|beta|rc)$' | \
            sort -rV | \
            head -n1)
          
          # 如果没有找到版本标签，尝试其他模式
          if [ -z "$LATEST_VERSION" ]; then
            echo "No semantic version found, trying alternative patterns..."
            LATEST_VERSION=$(echo "$TAGS_JSON" | jq -r '.results[].name' | \
              grep -E '^[0-9]+\.[0-9]+' | \
              grep -v -E '^(latest|nightly|dev)$' | \
              sort -rV | \
              head -n1)
          fi
          
          # 确保找到了有效的版本
          if [ -z "$LATEST_VERSION" ]; then
            echo "ERROR: No valid version tag found in Docker Hub"
            exit 1
          fi
          
          echo "LATEST_TAG=$LATEST_VERSION" >> $GITHUB_ENV
          echo "tag=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Docker latest version tag: $LATEST_VERSION"

      - name: Get latest ssfun/lobe-chat-database GitHub release tag
        id: get_github_tag
        run: |
          # 尝试获取最新的 release
          RESPONSE=$(curl -s -w "\n%{http_code}" 'https://api.github.com/repos/ssfun/lobe-chat-database/releases/latest')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" = "404" ]; then
            echo "No releases found in GitHub repository"
            GITHUB_TAG="v0.0.0"
            echo "Using default version: $GITHUB_TAG"
          elif [ "$HTTP_CODE" = "200" ]; then
            GITHUB_TAG=$(echo "$BODY" | jq -r '.tag_name')
            if [ "$GITHUB_TAG" = "null" ] || [ -z "$GITHUB_TAG" ]; then
              echo "No valid tag found in latest release"
              GITHUB_TAG="v0.0.0"
              echo "Using default version: $GITHUB_TAG"
            else
              echo "Found GitHub release tag: $GITHUB_TAG"
            fi
          else
            echo "Failed to fetch GitHub releases. HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            # 尝试获取所有标签作为备选方案
            echo "Trying to fetch tags instead..."
            GITHUB_TAG=$(curl -s 'https://api.github.com/repos/ssfun/lobe-chat-database/tags' | \
              jq -r '.[].name' | \
              grep -E '^v?[0-9]+\.[0-9]+' | \
              sort -rV | \
              head -n1)
            
            if [ -z "$GITHUB_TAG" ]; then
              GITHUB_TAG="v0.0.0"
              echo "No tags found, using default: $GITHUB_TAG"
            else
              echo "Found GitHub tag: $GITHUB_TAG"
            fi
          fi
          
          echo "GITHUB_TAG=$GITHUB_TAG" >> $GITHUB_ENV
          echo "tag=$GITHUB_TAG" >> $GITHUB_OUTPUT
          echo "GitHub latest tag: $GITHUB_TAG"

      - name: Compare versions and decide if packing is needed
        id: version_check
        run: |
          # 标准化版本号格式（移除 v 前缀）
          DOCKER_VERSION="${LATEST_TAG#v}"
          GITHUB_VERSION="${GITHUB_TAG#v}"
          
          echo "Comparing versions:"
          echo "Docker version: $DOCKER_VERSION"
          echo "GitHub version: $GITHUB_VERSION"
          
          # 版本比较函数
          version_gt() {
            # 使用 sort -V 进行版本比较
            # 如果第一个版本大于第二个版本，返回 0（true）
            [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" != "$1" ]
          }
          
          # 检查版本是否相同
          if [ "$DOCKER_VERSION" = "$GITHUB_VERSION" ]; then
            echo "Versions are identical, no need to pack"
            echo "should_pack=false" >> $GITHUB_OUTPUT
          elif version_gt "$DOCKER_VERSION" "$GITHUB_VERSION"; then
            echo "Docker version ($DOCKER_VERSION) is newer than GitHub version ($GITHUB_VERSION)"
            echo "should_pack=true" >> $GITHUB_OUTPUT
          else
            echo "Docker version ($DOCKER_VERSION) is not newer than GitHub version ($GITHUB_VERSION)"
            echo "should_pack=false" >> $GITHUB_OUTPUT
          fi
          
          # 输出决策摘要
          echo "---"
          echo "Decision summary:"
          echo "  Docker Hub version: v$DOCKER_VERSION"
          echo "  GitHub Release version: v$GITHUB_VERSION"
          echo "  Should pack: $([ "$DOCKER_VERSION" != "$GITHUB_VERSION" ] && version_gt "$DOCKER_VERSION" "$GITHUB_VERSION" && echo "YES" || echo "NO")"

  pack-binaries:
    needs: pack-and-release
    if: needs.pack-and-release.outputs.should_pack == 'true'
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.set_output.outputs.release_created }}
      version_tag: ${{ needs.pack-and-release.outputs.docker_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up dependencies for dockerc
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse overlayroot squashfs-tools skopeo jq curl

      - name: Download dockerc
        run: |
          wget -O dockerc https://github.com/NilsIrl/dockerc/releases/download/v0.3.2/dockerc_x86-64
          chmod +x ./dockerc

      - name: Pack lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }} for linux/amd64
        run: |
          echo "Packing AMD64 binary for version: ${{ needs.pack-and-release.outputs.docker_tag }}"
          ./dockerc --image docker://lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }} \
            --arch amd64 \
            --output lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin

      - name: Pack lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }} for linux/arm64
        run: |
          echo "Packing ARM64 binary for version: ${{ needs.pack-and-release.outputs.docker_tag }}"
          ./dockerc --image docker://lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }} \
            --arch arm64 \
            --output lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-arm64.bin

      - name: Generate SHA256 checksums
        run: |
          sha256sum lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin > checksums.txt
          sha256sum lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-arm64.bin >> checksums.txt
          echo "Generated checksums:"
          cat checksums.txt

      - name: Upload all bins to Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.pack-and-release.outputs.docker_tag }}
          files: |
            lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin
            lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-arm64.bin
            checksums.txt
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Release ${{ needs.pack-and-release.outputs.docker_tag }}"
          body: |
            ## 🚀 Automated Release for lobe-chat ${{ needs.pack-and-release.outputs.docker_tag }}
            
            ### 📦 Version Information
            - **Docker image version:** `${{ needs.pack-and-release.outputs.docker_tag }}`
            - **Previous GitHub release:** `${{ needs.pack-and-release.outputs.github_tag }}`
            - **Release date:** `$(date -u '+%Y-%m-%d %H:%M:%S UTC')`
            
            ### 📥 Downloads
            This release contains portable binary executables packed from the official Docker image.
            
            | Platform | Architecture | File |
            |----------|-------------|------|
            | Linux | x86_64/amd64 | `lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin` |
            | Linux | arm64/aarch64 | `lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-arm64.bin` |
            
            ### 🔒 Verification
            SHA256 checksums are available in `checksums.txt`
            
            ### 📝 Usage
            ```bash
            # Download the binary
            wget https://github.com/ssfun/lobe-chat-database/releases/download/${{ needs.pack-and-release.outputs.docker_tag }}/lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin
            
            # Make it executable
            chmod +x lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin
            
            # Run
            ./lobe-chat-${{ needs.pack-and-release.outputs.docker_tag }}-linux-amd64.bin
            ```
            
            ### 🐳 Docker Image
            Original Docker image: `lobehub/lobe-chat-database:${{ needs.pack-and-release.outputs.docker_tag }}`
            
            ---
            *This release was automatically generated from the Docker Hub image.*
      
      # 关键修复：正确设置输出
      - name: Set output for deployment trigger
        id: set_output
        run: |
          echo "release_created=true" >> $GITHUB_OUTPUT
          echo "Release created successfully, deployment will be triggered"

  deploy-to-server:
    needs: [pack-binaries]
    # 修复：使用正确的条件判断
    if: needs.pack-binaries.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # 允许某个服务器失败时继续部署其他服务器
      matrix:
        server: [server1]  # 可以扩展为多个服务器 [server1, server2, server3]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 添加调试信息
      - name: Debug deployment trigger
        run: |
          echo "Release created: ${{ needs.pack-binaries.outputs.release_created }}"
          echo "Version tag: ${{ needs.pack-binaries.outputs.version_tag }}"
          echo "Starting deployment to ${{ matrix.server }}"

      - name: Check required secrets
        env:
          SERVER_HOST: ${{ secrets[format('{0}_HOST', matrix.server)] }}
          SERVER_USER: ${{ secrets[format('{0}_USER', matrix.server)] }}
        run: |
          # 检查必需的环境变量
          if [ -z "${SERVER_HOST}" ]; then
            echo "ERROR: ${matrix.server}_HOST secret is not configured"
            exit 1
          fi
          
          if [ -z "${SERVER_USER}" ]; then
            echo "ERROR: ${matrix.server}_USER secret is not configured"
            exit 1
          fi
          
          echo "Server configuration verified for ${{ matrix.server }}"

      - name: Deploy to ${{ matrix.server }}
        env:
          SERVER_HOST: ${{ secrets[format('{0}_HOST', matrix.server)] }}
          SERVER_USER: ${{ secrets[format('{0}_USER', matrix.server)] }}
          SERVER_PASSWORD: ${{ secrets[format('{0}_PASSWORD', matrix.server)] }}
          SERVER_PORT: ${{ secrets[format('{0}_PORT', matrix.server)] || '22' }}
          LOBE_CHAT_ENV: ${{ secrets[format('{0}_LOBE_CHAT_ENV', matrix.server)] || '' }}
          VERSION_TAG: ${{ needs.pack-binaries.outputs.version_tag }}
        run: |
          # 安装 sshpass 用于密码登录
          sudo apt-get update && sudo apt-get install -y sshpass
          
          echo "Deploying version ${VERSION_TAG} to ${SERVER_HOST}"
          
          # 创建部署脚本
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          VERSION_TAG="${1}"
          LOBE_CHAT_ENV="${2}"
          
          echo "=========================================="
          echo "Starting deployment of lobe-chat"
          echo "Version: ${VERSION_TAG}"
          echo "Time: $(date)"
          echo "=========================================="
          
          # 检测系统架构
          ARCH=$(uname -m)
          case ${ARCH} in
              x86_64)
                  BINARY_ARCH="amd64"
                  ;;
              aarch64|arm64)
                  BINARY_ARCH="arm64"
                  ;;
              *)
                  echo "ERROR: Unsupported architecture: ${ARCH}"
                  exit 1
                  ;;
          esac
          
          echo "System info:"
          echo "  OS: $(uname -s)"
          echo "  Architecture: ${ARCH} (${BINARY_ARCH})"
          echo "  Hostname: $(hostname)"
          
          # 下载对应架构的二进制文件
          DOWNLOAD_URL="https://github.com/ssfun/lobe-chat-database/releases/download/${VERSION_TAG}/lobe-chat-${VERSION_TAG}-linux-${BINARY_ARCH}.bin"
          echo ""
          echo "Download URL: ${DOWNLOAD_URL}"
          
          # 创建临时目录
          TEMP_DIR=$(mktemp -d)
          echo "Working directory: ${TEMP_DIR}"
          cd ${TEMP_DIR}
          
          # 下载二进制文件（带进度显示）
          echo ""
          echo "Downloading binary file..."
          if ! wget --progress=bar:force -O lobe-chat.bin "${DOWNLOAD_URL}"; then
              echo "ERROR: Failed to download binary"
              rm -rf ${TEMP_DIR}
              exit 1
          fi
          
          # 验证文件大小
          FILE_SIZE=$(stat -c%s lobe-chat.bin)
          echo "Downloaded file size: ${FILE_SIZE} bytes"
          
          if [ ${FILE_SIZE} -lt 1000000 ]; then
              echo "WARNING: File size seems too small, might be corrupted"
          fi
          
          # 检查是否有运行中的 lobe-chat 进程
          echo ""
          echo "Checking for running processes..."
          OLD_PIDS=$(pgrep -f "/opt/lobe-chat/lobe-chat.bin" || true)
          
          if [ ! -z "${OLD_PIDS}" ]; then
              echo "Found running lobe-chat process(es): ${OLD_PIDS}"
              echo "Stopping old process(es)..."
              for pid in ${OLD_PIDS}; do
                  kill ${pid} || true
              done
              sleep 3
              # 强制终止如果还在运行
              for pid in ${OLD_PIDS}; do
                  kill -9 ${pid} 2>/dev/null || true
              done
              echo "Old process(es) stopped"
          else
              echo "No running lobe-chat process found"
          fi
          
          # 创建目标目录（如果不存在）
          if [ ! -d "/opt/lobe-chat" ]; then
              echo ""
              echo "Creating directory /opt/lobe-chat"
              sudo mkdir -p /opt/lobe-chat
              sudo chown $(whoami):$(whoami) /opt/lobe-chat || true
          fi
          
          # 备份旧版本（如果存在）
          if [ -f "/opt/lobe-chat/lobe-chat.bin" ]; then
              BACKUP_NAME="/opt/lobe-chat/lobe-chat.bin.backup.$(date +%Y%m%d_%H%M%S)"
              echo ""
              echo "Backing up old version to ${BACKUP_NAME}"
              sudo mv /opt/lobe-chat/lobe-chat.bin ${BACKUP_NAME}
              
              # 只保留最新的3个备份
              echo "Cleaning old backups..."
              ls -t /opt/lobe-chat/lobe-chat.bin.backup.* 2>/dev/null | tail -n +4 | xargs rm -f 2>/dev/null || true
          fi
          
          # 移动新版本到目标位置
          echo ""
          echo "Installing new version..."
          sudo mv lobe-chat.bin /opt/lobe-chat/lobe-chat.bin
          
          # 设置执行权限
          echo "Setting execute permissions..."
          sudo chmod +x /opt/lobe-chat/lobe-chat.bin
          
          # 清理临时目录
          cd /
          rm -rf ${TEMP_DIR}
          
          # 创建或清理日志文件
          sudo touch /opt/lobe-chat/lobe-chat.log
          sudo chmod 666 /opt/lobe-chat/lobe-chat.log || true
          
          # 启动新版本
          echo ""
          echo "Starting lobe-chat..."
          if [ -z "${LOBE_CHAT_ENV}" ]; then
              echo "Starting without additional parameters"
              nohup /opt/lobe-chat/lobe-chat.bin > /opt/lobe-chat/lobe-chat.log 2>&1 &
          else
              echo "Starting with parameters: ${LOBE_CHAT_ENV}"
              nohup /opt/lobe-chat/lobe-chat.bin ${LOBE_CHAT_ENV} > /opt/lobe-chat/lobe-chat.log 2>&1 &
          fi
          
          echo "Process started, waiting for initialization..."
          sleep 5
          
          # 验证进程是否成功启动
          echo ""
          echo "Verifying deployment..."
          NEW_PIDS=$(pgrep -f "/opt/lobe-chat/lobe-chat.bin" || true)
          if [ ! -z "${NEW_PIDS}" ]; then
              echo "✅ lobe-chat started successfully"
              echo "Process ID(s): ${NEW_PIDS}"
              echo ""
              echo "=========================================="
              echo "Deployment completed successfully!"
              echo "Version ${VERSION_TAG} is now running"
              echo "=========================================="
              echo ""
              echo "Recent logs (last 20 lines):"
              echo "------------------------------------------"
              tail -n 20 /opt/lobe-chat/lobe-chat.log 2>/dev/null || echo "No logs available yet"
              exit 0
          else
              echo "❌ Failed to start lobe-chat"
              echo ""
              echo "Error logs (last 50 lines):"
              echo "------------------------------------------"
              tail -n 50 /opt/lobe-chat/lobe-chat.log 2>/dev/null || echo "No logs available"
              exit 1
          fi
          EOF
          
          # 使用 sshpass 执行部署脚本
          echo "Connecting to ${SERVER_HOST}:${SERVER_PORT} as ${SERVER_USER}"
          
          # 执行部署
          if sshpass -p "${SERVER_PASSWORD}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            -p ${SERVER_PORT} ${SERVER_USER}@${SERVER_HOST} \
            "bash -s" < deploy.sh "${VERSION_TAG}" "${LOBE_CHAT_ENV}"; then
            echo "DEPLOYMENT_SUCCESS=true" >> $GITHUB_ENV
            echo "✅ Deployment to ${matrix.server} completed successfully"
          else
            echo "DEPLOYMENT_SUCCESS=false" >> $GITHUB_ENV
            echo "❌ Deployment to ${matrix.server} failed"
            exit 1
          fi

      - name: Send Telegram notification
        if: env.DEPLOYMENT_SUCCESS == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION_TAG: ${{ needs.pack-binaries.outputs.version_tag }}
          SERVER_NAME: ${{ matrix.server }}
        run: |
          # 只在配置了 Telegram 的情况下发送通知
          if [ ! -z "${TELEGRAM_BOT_TOKEN}" ] && [ ! -z "${TELEGRAM_CHAT_ID}" ]; then
            # 构建消息内容
            MESSAGE="🚀 *Lobe Chat Deployment Success*
            
📦 *Version:* \`${VERSION_TAG}\`
🖥️ *Server:* ${SERVER_NAME}
⏰ *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')
✅ *Status:* Deployed and running

🔗 [View Release](https://github.com/ssfun/lobe-chat-database/releases/tag/${VERSION_TAG})"
            
            # 发送 Telegram 消息
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
                \"text\": \"${MESSAGE}\",
                \"parse_mode\": \"Markdown\",
                \"disable_web_page_preview\": true
              }" > /dev/null
            
            echo "Telegram notification sent successfully"
          else
            echo "Telegram credentials not configured, skipping notification"
          fi

  # 部署失败时的通知
  notify-failure:
    needs: [pack-binaries, deploy-to-server]
    if: failure() && needs.pack-binaries.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Send failure notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION_TAG: ${{ needs.pack-binaries.outputs.version_tag }}
        run: |
          if [ ! -z "${TELEGRAM_BOT_TOKEN}" ] && [ ! -z "${TELEGRAM_CHAT_ID}" ]; then
            MESSAGE="❌ *Lobe Chat Deployment Failed*
            
📦 *Version:* \`${VERSION_TAG}\`
⏰ *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')
📝 *Workflow:* ${{ github.workflow }}
🔗 [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
                \"text\": \"${MESSAGE}\",
                \"parse_mode\": \"Markdown\",
                \"disable_web_page_preview\": true
              }" > /dev/null
          fi
